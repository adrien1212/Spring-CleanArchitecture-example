<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Base de données - Créer une application d&#x27;entreprise avec Spring</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../Introduction/Introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Architecture</li><li class="chapter-item expanded "><a href="../../../Architecture/Generale.html"><strong aria-hidden="true">2.</strong> Architecture Générale</a></li><li class="chapter-item expanded "><a href="../../../Configuration/Configuration.html"><strong aria-hidden="true">3.</strong> Configuration MicroServices</a></li><li class="chapter-item expanded "><a href="../../../Architecture/Microservice.html"><strong aria-hidden="true">4.</strong> Architecture Détaillée</a></li><li class="chapter-item expanded affix "><li class="part-title">Compte bancaire</li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Introduction.html"><strong aria-hidden="true">5.</strong> BankAccount</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Configuration.html"><strong aria-hidden="true">5.1.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Architecture.html"><strong aria-hidden="true">5.2.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Domaine.html"><strong aria-hidden="true">5.3.</strong> Domaine</a></li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Service.html"><strong aria-hidden="true">5.4.</strong> Service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Service/DTO.html"><strong aria-hidden="true">5.4.1.</strong> DTO</a></li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Service/BDD.html" class="active"><strong aria-hidden="true">5.4.2.</strong> Base de données</a></li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Service/Business.html"><strong aria-hidden="true">5.4.3.</strong> Service Métier</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Controller.html"><strong aria-hidden="true">5.5.</strong> Contrôleur</a></li><li class="chapter-item expanded "><a href="../../../Conception/bankaccount/Tester.html"><strong aria-hidden="true">5.6.</strong> Tester</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Authentification</li><li class="chapter-item expanded "><a href="../../../Conception/registration/Introduction.html"><strong aria-hidden="true">6.</strong> Authentification</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/registration/Configuration.html"><strong aria-hidden="true">6.1.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Architecture.html"><strong aria-hidden="true">6.2.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Domaine.html"><strong aria-hidden="true">6.3.</strong> Domaine</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Service.html"><strong aria-hidden="true">6.4.</strong> Service</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/registration/Service/DTO.html"><strong aria-hidden="true">6.4.1.</strong> DTO</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Service/BDD.html"><strong aria-hidden="true">6.4.2.</strong> Base de données</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Service/Business.html"><strong aria-hidden="true">6.4.3.</strong> Service Métier</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Security/Securite.html"><strong aria-hidden="true">6.5.</strong> Sécurité</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/registration/Security/SpringSecurityArchitecture.html"><strong aria-hidden="true">6.5.1.</strong> Architecture Spring Security</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Security/SpringConfiguration.html"><strong aria-hidden="true">6.5.2.</strong> Implémentation Architecture</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Security/UserDetailService.html"><strong aria-hidden="true">6.5.3.</strong> Notion d'utilisateur Spring</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Controller.html"><strong aria-hidden="true">6.5.4.</strong> Contrôleur</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Tester.html"><strong aria-hidden="true">6.5.5.</strong> Tester</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Basic/Basic.html"><strong aria-hidden="true">6.6.</strong> Authentification Basic</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/registration/Basic/SecurityConfig.html"><strong aria-hidden="true">6.6.1.</strong> SecurityConfig</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Basic/Controleur.html"><strong aria-hidden="true">6.6.2.</strong> Controleur</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Conception/registration/JWT/JWT.html"><strong aria-hidden="true">6.7.</strong> Authentification JWT</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/registration/JWT/Configuration.html"><strong aria-hidden="true">6.7.1.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/JWT/generate.html"><strong aria-hidden="true">6.7.2.</strong> Generer token</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/JWT/filter.html"><strong aria-hidden="true">6.7.3.</strong> JWTAuthenticationFilter</a></li><li class="chapter-item expanded "><a href="../../../Conception/registration/JWT/Controller.html"><strong aria-hidden="true">6.7.4.</strong> Controleur</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Conception/registration/Conclusion.html"><strong aria-hidden="true">6.8.</strong> Conclusion</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Gateway</li><li class="chapter-item expanded "><a href="../../../Conception/gateway/Introduction.html"><strong aria-hidden="true">7.</strong> Gateway</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Conception/gateway/Configuration.html"><strong aria-hidden="true">7.1.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../../../Conception/gateway/Tester.html"><strong aria-hidden="true">7.2.</strong> Tester</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Créer une application d&#x27;entreprise avec Spring</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="base-de-données"><a class="header" href="#base-de-données">Base de données</a></h1>
<p>Pour pour persister des informations en base de données nous allons utiliser des librairies externes. Afin de protéger le coeur de notre application la communication avec la librairie externe se fera à travers d'un adaptateur.
Nous avons choisis cette solution car :</p>
<ul>
<li>Si la librairie externe utilisée modifie son interface alors seule la classe Adaptateur devra être adaptée.</li>
<li>Si nous décidons d'utiliser une autre librairie qui ne respecte pas les spécification JPA alors seule la classe Adaptateur devra être adaptée.</li>
</ul>
<p><strong>Ainsi avec cette option, le coeur restera inchangé quelques soient les choix et directive sur les librairies externes</strong></p>
<p><img src="../Images/BDD.png" alt="" /></p>
<h2 id="entités-jpa"><a class="header" href="#entités-jpa">Entités JPA</a></h2>
<p>Dans notre application nous avons deux types d'entités</p>
<ul>
<li>Les entités du domaine</li>
<li>Les entités JPA</li>
</ul>
<p>Malgré leur forte similitude il est important deux les distinguer dans deux classes séparées. En effet, le coeur applicatif ne doit pas savoir comment les entités sont persistées (fichier, bases de données, etc ...). Ainsi, le lien entre les entités du domaine et les entités JPA sera fait par l'implémentation <code>AccountGatewayIml</code></p>
<p>Ensuite, lorsque nous créons une entité JPA nous devons préciser :</p>
<ul>
<li>que c'est une entité via l'annonation <code>@Entity</code></li>
<li>la table où cette entité est persisté <code>@Table(nom_table)</code></li>
<li>par la suite nous vous spécifier des options sur certain attributs :
<ul>
<li><code>@Id</code> pour l'identifiant</li>
<li><code>@OneToOne</code> lorsque nous avons une relation de dépendance entre deux tables</li>
<li>etc ... </li>
</ul>
</li>
</ul>
<pre><code class="language-Java">@Entity
@Table(name = &quot;account&quot;)
public class AccountJpaEntity {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private long id;

	@NonNull
	private Long customerId;

	@NonNull
	private String name;

	@NonNull
	private LocalDateTime createdAt;

	@OneToOne(cascade = { CascadeType.ALL })
	@NonNull
	private BalanceJPAEntity balanceJPAEntity;

	@Enumerated(EnumType.STRING)
	@NonNull
	private AccountTypeJPAEnum accountType;
}
</code></pre>
<pre><code class="language-Java">@Entity
@Table(name = &quot;balance&quot;)
public class BalanceJPAEntity {
	@Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
	private long id;

	@NonNull
	private double amount;

	@ElementCollection
	@CollectionTable(name = &quot;transaction&quot;, joinColumns = @JoinColumn(name = &quot;id&quot;))
	@Column(name = &quot;transactions&quot;)
	private List&lt;Integer&gt; transactionList;

	@NonNull
	private LocalDateTime lastUpdate;
}
</code></pre>
<pre><code class="language-Java">public enum AccountTypeJPAEnum {
	CHEQUE, EPARGNE
}
</code></pre>
<h2 id="le-repository"><a class="header" href="#le-repository">Le Repository</a></h2>
<p>Il orchestre l'<em>entity manager</em> pour la persistance en base de données. Pour créer notre propre <em>repository</em> nous devons implémenter l'interface <code>JPARepository</code>.</p>
<p>En implémentant cette interface nous n'avons pas besoin d'écrire les méthodes de base comme <code>save</code>, <code>delete</code>, <code>getById</code>, etc ... elles ont déjà été implémentées. Cependant si nous souhaitons des méthodes plus spécifique à notre problème alors nous devons les écrires.</p>
<p>Par exemple, nous avons définie une méthode qui permet lister tous les comptes d'un utilisateur</p>
<pre><code class="language-Java">public interface AccountJpaRepository extends JpaRepository&lt;AccountJpaEntity, Long&gt; {
	List&lt;AccountJpaEntity&gt; findByCustomerId(Long idCustomer);

	Optional&lt;AccountJpaEntity&gt; findByCustomerIdAndName(Long idCustomer, String name);

	List&lt;AccountJpaEntity&gt; findByCustomerIdAndAccountType(Long idCustomer, AccountTypeJPAEnum accountType);
}
</code></pre>
<p>Ce qui est encore plus fort, c'est que nous n'avons même pas besoin d'implémenter cette classe. En effet, en écrivant bien le nom des méthodes <code>find</code> + <code>By</code> + <code>something</code> où le <code>something</code> un attribut dans nos entités JPA, le framwork est capable d'écrire automatiquement la requête SQL précise.</p>
<h2 id="la-gateway"><a class="header" href="#la-gateway">La Gateway</a></h2>
<p>Elle traduit nos :</p>
<ul>
<li>entités JPA en entités domaine</li>
<li>entités domaine en entités JPA</li>
</ul>
<pre><code class="language-java">public interface AccountGateway {

	void create(Long idCustomer, String accountName, AccountType accountType);
	void updateName(Long accountId, String newAccountName);
	void delete(Long idAccount);
	Account findByAccountId(Long idAccount);
	Account findByCustomerIdAndByName(Long idCustomer, String name);
	Account findByCustomerIdAndAccountId(Long idCustomer, Long idAccount);
	List&lt;Account&gt; findAllAccounts(Long idCustomer);
	List&lt;Account&gt; findByCustomerIdAndAccountType(Long customerId, AccountType accountType);
}
</code></pre>
<h3 id="la-méthode-create"><a class="header" href="#la-méthode-create">La méthode create</a></h3>
<p><strong>Objectif</strong>
Créer un nouveau compte bancaire à un utilisateur. Elle prend donc en paramètre l'identifiant du client, le nom du compte à créer ainsi que son type. </p>
<ol>
<li>Crée l'ensemble des entités JPA nécessaire en utilisant les paramètres</li>
<li>Appelle la méthode <code>save</code> disponible dans <code>AccountJPARepository</code> (car elle implémente <code>JPARepository</code>)</li>
</ol>
<pre><code class="language-Java">@Component
public class AccountGatewayImpl implements AccountGateway {

	private final AccountJpaRepository accountJpaRepository;

	@Override
	public void create(Long idCustomer, String accountName, AccountType accountType) {
		accountJpaRepository.save(
            new AccountJpaEntity(idCustomer, accountName, LocalDateTime.now(),
				new BalanceJPAEntity(0.0, LocalDateTime.now()), AccountTypeJPAEnum.valueOf(accountType.name())));
	}
    ...
}
</code></pre>
<h3 id="la-méthode-findallaccounts"><a class="header" href="#la-méthode-findallaccounts">La méthode findAllAccounts</a></h3>
<p><strong>Objectif</strong>
Récupérer tous les compte bancaires qu'un utilisateur possède</p>
<ol>
<li>Appeler la méthode <code>findByCustomerId</code> créée précédement dans <code>AccountJpaRepository</code></li>
<li>Convertir chaque AccountJPAEntity en Account. En effet, la partie métier ne traite que les entités du domaine</li>
<li>Retourner la liste</li>
</ol>
<pre><code class="language-Java">@Override
public List&lt;Account&gt; findAllAccounts(Long idCustomer) {
    List&lt;Account&gt; toReturn = new ArrayList&lt;&gt;();
    for (AccountJpaEntity accountJpaEntity : accountJpaRepository.findByCustomerId(idCustomer)) {
        toReturn.add(accountJpaToDomain(accountJpaEntity));
    }
    return toReturn;
}

private Account accountJpaToDomain(AccountJpaEntity jpaEntity) {
    return Account.builder().name(jpaEntity.getName())
            .accountType(AccountType.valueOf(jpaEntity.getAccountType().name()))
            .balance(balanceJpaToDomain(jpaEntity.getBalanceJPAEntity())).build();
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../Conception/bankaccount/Service/DTO.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../../Conception/bankaccount/Service/Business.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../Conception/bankaccount/Service/DTO.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../../Conception/bankaccount/Service/Business.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
